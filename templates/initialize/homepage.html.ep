<!DOCTYPE HTML PUBLIC '-//W3C//DTD HTML 4.01//EN'
'http://www.w3.org/TR/html4/strict.dtd'>
<html>

<head>

	<title>Garden Design</title>
	<meta http-equiv = 'Content-Type' content = 'text/html; charset = utf-8' />

    <link rel = 'stylesheet' type = 'text/css' href = 'http://127.0.0.1/assets/js/jQuery/jquery-ui-1.12.1/jquery-ui.min.css'>
    <link rel = 'stylesheet' type = 'text/css' href = 'http://127.0.0.1/assets/js/jQuery/datatable.2.0.0/css/datatable.min.css'>
	<!-- Warning: The next line must not be put after the spectrum line, or the CSS in it fails to work. -->
	<link rel = 'stylesheet' type = 'text/css' href = '/assets/css/www/garden/design/homepage.css'>
	<link rel = 'stylesheet' type = 'text/css' href = 'http://127.0.0.1/assets/js/jQuery/bgrins-spectrum-98454b5/spectrum.css'

</head>

<body>

<h3 class = 'blue_centered'>Garden Design</h3>

<div id = 'global_tab_div'>
	<ul>
		<li><a href = '#global_search_tab'><span>Search</span></a></li>
		<li><a href = '#global_details_tab'><span>Details</span></a></li>
		<li><a href = '#global_garden_tab'><span>Gardens</span></a></li>
		<li><a href = '#global_object_tab'><span>Objects</span></a></li>
		<li><a href = '#global_design_tab'><span>Design</span></a></li>
		<li><a href = '#global_help_tab'><span>Help</span></a></li>
	</ul>
	<div id = 'global_search_tab'>
%= include 'initialize/search'
	</div>
	<div id = 'global_details_tab'>
%= form_for '/details' => (method => 'POST') => begin
	    <ul>
	        <li><a href = '#flower_tab'><span>Flower</span></a></li>
	        <li><a href = '#attributes_tab'><span>Attributes</span></a></li>
	        <li><a href = '#images_tab'><span>Images</span></a></li>
	        <li><a href = '#notes_tab'><span>Notes</span></a></li>
	        <li><a href = '#urls_tab'><span>URLs</span></a></li>
	    </ul>
	    <div id = 'flower_tab'>
%= include 'initialize/flower'
		</div>
	    <div id = 'attributes_tab'>
%= include 'initialize/attributes'
		</div>
	    <div id = 'images_tab'>
%= include 'initialize/images', constants => $constants
		</div>
	    <div id = 'notes_tab'>
%= include 'initialize/notes', constants => $constants
		</div>
	    <div id = 'urls_tab'>
%= include 'initialize/urls'
		</div>
%=end
	</div>
	<div id = 'global_garden_tab'>
%= include 'initialize/garden'
	</div>
	<div id = 'global_object_tab'>
%= include 'initialize/object'
	</div>
	<div id = 'global_design_tab'>
%= include 'initialize/design'
	</div>
	<div id = 'global_help_tab'>
		<div id = 'help_div'>
		    <ul>
		        <li><a href = '#search_help_tab'><span>Searching</span></a></li>
		        <li><a href = '#faq_help_tab'><span>FAQ</span></a></li>
		    </ul>
		    <div id = 'search_help_tab'>
%= include 'initialize/search_help'
			</div>
		    <div id = 'faq_help_tab'>
%= include 'initialize/faq_help'
			</div>
		</div>
	</div>
</div>

</body>

%= javascript 'http://127.0.0.1/assets/js/jQuery/jquery-2.1.4.min.js'
<script>$.uiBackCompat = false;</script>
%= javascript 'http://127.0.0.1/assets/js/jQuery/jquery-ui-1.12.1/jquery-ui.min.js'
%= javascript 'http://127.0.0.1/assets/js/jQuery/datatable.2.0.0/js/datatable.min.js'
%= javascript 'http://127.0.0.1/assets/js/jQuery/datatable.2.0.0/js/datatable.jquery.min.js'
%= javascript 'http://127.0.0.1/assets/js/jQuery/bgrins-spectrum-98454b5/spectrum.js'

<script type = 'text/javascript'>

// Storage for info read in below from the database.

var attribute_types_table = [];

// -----------------------------------------------

$(function()
{
	$('#aliases').autocomplete
	({
		source:		'/AutoComplete?type=aliases',
		minLength:	2,
		select:		function(event, ui)
		{
			$('#aliases').empty().append(ui.item ? ui.item.value : '-');
		}
	});

}); // End of autocomplete function.

// -----------------------------------------------

$(function()
{
	$('#color_code').autocomplete
	({
		source:		'/AutoComplete?type=color_code',
		minLength:	2,
		select:		function(event, ui)
		{
			if (ui.item)
			{
				$('#color_code').empty().append(ui.item.value);
				$('#color_swatch_chosen').css('background-color', ui.item.value);
			}
		}
	});

}); // End of autocomplete function.

// -----------------------------------------------

$(function()
{
	$('#color_name').autocomplete
	({
		source:		'/AutoComplete?type=color_name',
		minLength:	2,
		select:		function(event, ui)
		{
			if (ui.item)
			{
				$('#color_name').empty().append(ui.item.value);
				$('#color_swatch_chosen').css('background-color', ui.item.value);
			}
		}
	});

}); // End of autocomplete function.

// -----------------------------------------------

$(function()
{
	$('#common_name').autocomplete
	({
		source:		'/AutoComplete?type=common_name',
		minLength:	2,
		select:		function(event, ui)
		{
			$('#common_name').empty().append(ui.item ? ui.item.value : '-');
		}
	});

}); // End of autocomplete function.

// -----------------------------------------------

$(function()
{
	$('#garden_name').autocomplete
	({
		source:		'/AutoComplete?type=garden_name',
		minLength:	2,
		select:		function(event, ui)
		{
			if (ui.item)
			{
				$('#garden_name').empty().append(ui.item.value);
			}
		}
	});

}); // End of autocomplete function.

// -----------------------------------------------

$(function()
{
	$('#object_name').autocomplete
	({
		source:		'/AutoComplete?type=object_name',
		minLength:	2,
		select:		function(event, ui)
		{
			$('#object_name').empty().append(ui.item ? ui.item.value : '-');
		}
	});

}); // End of autocomplete function.

// -----------------------------------------------

$(function()
{
	$('#scientific_name').autocomplete
	({
		source:		'/AutoComplete?type=scientific_name',
		minLength:	2,
		select:		function(event, ui)
		{
			$('#scientific_name').empty().append(ui.item ? ui.item.value : '-');
		}
	});

}); // End of autocomplete function.

// -----------------------------------------------

$(function()
{
	$("#search_text").autocomplete
	({
		source: "/AutoComplete?type=search",
		minLength: 2,
		select: function(event, ui)
		{
			$("#search_text").empty().append(ui.item ? ui.item.value : "-");
		}
	});
});

// -----------------------------------------------

function build_attribute_id(kind, name, value)
{
	// We must allow for range values like 'Full sun' and 'Semi-dwarf'.

	value = value.replace(/\s|-/g, '_');

	return '#' + kind + '_' + name + '_' + value;

} // End of build_attribute_id.

// -----------------------------------------------

function build_image_ids(sequence)
{
	// Names are in alphabetical order.

	var ids =
	[
		'#image_description_' + sequence,	// 0.
		'#image_file_name_' + sequence,		// 1.
		'#image_image_' + sequence,			// 2.
		'#image_sequence_' + sequence		// 3.
	];

	return ids;

} // End of build_image_ids.

// -----------------------------------------------

function build_note_ids(sequence)
{
	// Names are in alphabetical order.

	var ids	=
	[
		'#note_note_' + sequence,		// 0.
		'#note_sequence_' + sequence	// 1.
	];

	return ids;

} // End of build_note_ids.

// -----------------------------------------------

function build_url_ids(sequence)
{
	// Names are in alphabetical order.

	var ids	=
	[
		'#url_sequence_' + sequence,	// 0.
		'#url_url_' + sequence			// 1.
	];

	return ids;

} // End of build_url_ids.

// -----------------------------------------------

function get_attribute_types_table()
{
	$.ajax
	({
		dataType:	'json',
		type:		'POST',
		url:		'/GetAttributeTypes'
	}).success(function(json)
	{
		attribute_types_table = json;
	});

} // End of get_attribute_types_table.

// -----------------------------------------------

function populate_details(flower_id)
{
	$.ajax
	({
		data:
		{
			flower_id: flower_id
		},
		dataType:	'json',
		type:		'POST',
		url:		'/GetDetails'
	}).success(function(flower)
	{
		// Make the Details tab, tab 1, active.

		$('#global_tab_div').tabs('option', 'active', 1);

		// Copy flower data to the Details/Flower tab.

		$('#flower_common_name').val(flower['common_name']);
		$('#flower_scientific_name').val(flower['scientific_name']);
		$('#flower_aliases').val(flower['aliases']);
		$('#flower_height').val(flower['height']);
		$('#flower_width').val(flower['width']);

		var thumbnail_size		= <%== $$constants{search_thumbnail_size} %>;
		var thumbnail_string	= "width = '" + thumbnail_size + "' height = '" + thumbnail_size + "'";
		var homepage_url		= <%== $$constants{homepage_url4js} %>;
		var image_url			= <%== $$constants{image_url4js} %>;
		var image_path			= homepage_url + image_url + '/' + flower['pig_latin'] + '.0.jpg';
		var thumbnail_html		= "<img src = '" + image_path + "' " + thumbnail_string + '>';

		$('#flower_thumbnail').html(thumbnail_html);

		// Copy basic flower data to the Details/Flower's other sub-tabs.
		// Warning: Don't include 'details' in the tabs array, because
		// it's fields are input fields, while all others are spans.

		var tabs = ['attribute', 'note', 'image', 'url'];
		var vars = ['common_name', 'scientific_name'];

		for (i = 0; i < tabs.length; i++)
		{
			for (j = 0; j < vars.length; j++)
			{
				id = '#' + tabs[i] + '_' + vars[j];

				$(id).text(flower[vars[j] ]);
			}
		}

		// Copy attributes to the Details/Attributes tab.

		var attribute_name;
		var id;
		var range = new Array();
		var value;

		// Attributes: Copy attribute types to the Flower/Attributes tab.
		// 1: Remove any existing attributes.

		for (j = 0; j < attribute_types_table.length; j++)
		{
			attribute_name	= attribute_types_table[j]['name'];
			range			= attribute_types_table[j]['range'].split(', ');

			for (k = 0; k < range.length; k++)
			{
				value	= range[k];
				id		= build_attribute_id('attribute', attribute_name, value);

				$(id).prop('checked', false);
			}
		}

		var attribute;
		var attribute_type_name;

		// 2: Loop over all attributes owned by this flower.

		for (i = 0; i < flower['attributes'].length; i++)
		{
			attribute		= flower['attributes'][i];
			attribute_name	= attribute['name'];
			range			= attribute['range'].split(', ');

			// Loop over all attribute types.

			for (j = 0; j < attribute_types_table.length; j++)
			{
				attribute_type_name = attribute_types_table[j]['name'];

				// Find the attribute type whose name matches the name of the flower's attribute.

				if (attribute_name != attribute_type_name)
				{
					continue;
				}

				for (k = 0; k < range.length; k++)
				{
					value	= range[k];
					id		= build_attribute_id('attribute', attribute_name, value);

					if (value != '')
					{
						$(id).prop('checked', true);
					}
				}
			}
		}

		// Images: Copy images to the Details/Images tab.
		// 1: Remove any existing images.

		var ids			= [];
		var image_count	= <%== $$constants{max_image_count} %>;

		for (i = 0; i < image_count; i++)
		{
			ids.push(build_image_ids(i + 1) );

			// For the HTML column order, see templates/initialize/images.html.ep.

			$(ids[i][0]).val('');	// Description.
			$(ids[i][1]).val('');	// File name.
			$(ids[i][2]).text('');	// Image.
			$(ids[i][3]).val('');	// Sequence.
		}

		// 2: Loop over all images owned by this flower.

		ids			= [];
		image_count	= (flower['images'].length > image_count) ? image_count : flower['images'].length;

		var description;
		var file_name;
		var sequence;

		for (i = 0; i < image_count; i++)
		{
			description		= flower['images'][i]['description'];
			file_name		= flower['images'][i]['file_name'];
			sequence		= flower['images'][i]['sequence'];
			ids[i]			= build_image_ids(sequence);
			image_path		= homepage_url + image_url + '/' + file_name;
			thumbnail_html	= "<img src = '" + image_path + "' " + thumbnail_string + '>';

			// For the HTML column order, see templates/initialize/images.html.ep.

			$(ids[i][0]).val(description);
			$(ids[i][1]).val(file_name);
			$(ids[i][2]).html(thumbnail_html);
			$(ids[i][3]).val(sequence);
		}

		// Notes: Copy notes to the Details/Notes tab.
		// 1: Remove any existing notes.

		ids			= [];
		note_count	= <%== $$constants{max_note_count} %>;

		for (i = 0; i < note_count; i++)
		{
			ids.push(build_note_ids(i + 1) );

			// For the HTML column order, see templates/initialize/notes.html.ep.

			$(ids[i][0]).val('');	// Note.
			$(ids[i][1]).val('');	// Sequence.
		}

		// 2: Loop over all notes owned by this flower.

		ids			= [];
		note_count	= (flower['notes'].length > note_count) ? note_count : flower['notes'].length;

		var note;

		for (i = 0; i < note_count; i++)
		{
			note		= flower['notes'][i]['note'];
			sequence	= flower['notes'][i]['sequence'];
			ids[i]		= build_note_ids(sequence);

			// For the HTML column order, see templates/initialize/notes.html.ep.

			$(ids[i][0]).val(note);
			$(ids[i][1]).val(sequence);
		}

		// URLs: Copy urls to the Details/URLs tab.
		// 1: Remove any existing URLs.

		ids			= [];
		url_count	= <%== $$constants{max_url_count} %>;

		for (i = 0; i < url_count; i++)
		{
			ids.push(build_url_ids(i) );

			// For the HTML column order, see templates/initialize/urls.html.ep.

			$(ids[i][0]).val('');	// Sequence.
			$(ids[i][1]).val('');	// URL.
		}

		// 2: Loop over all URLs owned by this flower.

		ids			= [];
		url_count	= (flower['urls'].length > url_count) ? url_count : flower['urls'].length;

		var url;

		for (i = 0; i < url_count; i++)
		{
			sequence	= flower['urls'][i]['sequence'];
			url			= flower['urls'][i]['url'];
			ids[i]		= build_url_ids(sequence);

			// For the HTML column order, see templates/initialize/urls.html.ep.

			$(ids[i][0]).val(sequence);
			$(ids[i][1]).val(url);
		}
	});

} // End of populate_details.

// -----------------------------------------------

function submit_flower()
{
	$.ajax
	({
		data:
		{
			aliases:			document.aliases.value,
			common_name:		document.common_name.value,
			edible:				document.attributes_form.edible.value,
			habit:				document.attributes_form.habit.value,
			native:				document.attributes_form.native,
			scientific_name:	document.scientific_name.value,
			sun_tolerance:		document.attributes_form.sun_tolerance.value
		},
		dataType:	'text',
		type:		'POST',
		url:		'/AddFlower'
	}).success(function(html)
	{
		// $('#flower_result_div').empty().append(html);

		$('#flower_result_div').empty().text('Hi!');
	});

} // End of submit_flower.

// -----------------------------------------------

function submit_search()
{
	var fields = new Object();

	fields['csrf_token']	= $('#csrf_token').val();
	fields['search_text']	= $('#search_text').val();

	// Copy attributes from the search form.

	var attribute_name;
	var id;
	var name;
	var range = new Array();
	var value;

	for (j = 0; j < attribute_types_table.length; j++)
	{
		attribute_name	= attribute_types_table[j]['name'];
		range			= attribute_types_table[j]['range'].split(', ');

		for (k = 0; k < range.length; k++)
		{
			value			= range[k];
			id				= build_attribute_id('search', attribute_name, value);
			name			= id.substr(1); // Discard leading '#' to get the name to submit.
			fields[name]	= $(id).prop('checked'); // Returns 'true' or 'false'.
		}
	}

	$.ajax
	({
		data:		fields,
		dataType:	'html',
		type:		'POST',
		url:		'/Search'
	}).success(function(html)
	{
		$('#search_result_div').empty().append(html);
		$('#search_text').focus();
	});

} // End of submit_search.

// -----------------------------------------------

$(function()
{
	// Enable the tabs before trying to work with them.

	$('global_tab_div')
	.tabs
	({
		active: 1
	});

	$('#search_text').focus();

	// If the Search tab is selected, give the focus to the search text.

	$('#global_tab_div')
	.tabs
	({
		activate: function(event, ui)
		{
			$('#search_text').focus();
		}
	});

	// If the Objects tab is selected, giv the focus to the object name.

	$('#global_object_tab')
	.tabs
	({
		activate: function(event, ui)
		{
			$('#object_name').focus();
		}
	});

	// Active sub-tabs for Detail and Help.

	$("#global_details_tab")
	.tabs
	({
		active: 0
	});

	$("#global_help_tab")
	.tabs
	({
		active: 0
	});

	$('#flower_form').submit(function()
	{
		submit_flower();

		return false;
	});

	$('#color_spectrum').spectrum
	({
		change:				function(color)
							{
								$('#color_swatch_chosen').css('background-color', color.toHexString() );
							},
		color:				'white',
		preferredFormat:	'hex',
		showInput:			true,
		showPalette:		true
	});

	$('#search_form').submit(function()
	{
		submit_search();

		return false;
	});

	get_attribute_types_table();
});

</script>

</html>
